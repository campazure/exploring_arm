name: 0.$(Rev:rr)
trigger:
  branches:
    include:
    - master
  paths:
    exclude:
    - readme.md
stages:
- stage: CI
  displayName: Continuous Integration
  jobs:
  - job: buildlab
    displayName: Build lab content
    pool:
      vmImage: ubuntu-latest
    steps:
    - script: echo 'test'
      displayName: Test
  - job: buildpptx
    displayName: Build PowerPoint deck
    pool:
      vmImage: ubuntu-latest
    container:
      image: seesharprun/campazure:latest
    steps:
    - script: cp /theme.pptx .
      displayName: Copy resource files
    - script: pandoc content.md --from markdown --to pptx --slide-level 2 --self-contained --reference-doc theme.pptx --output $(Build.ArtifactStagingDirectory)/$(Build.Repository.Name)-$(Build.BuildNumber).pptx
      displayName: Build PowerPoint file from Markdown content
    - task: PublishBuildArtifacts@1
      displayName: Publish PowerPoint file build artifact
      inputs:
        pathtoPublish: $(Build.ArtifactStagingDirectory)
        artifactName: deck
- stage: CD
  displayName: Continuous Deployment
  dependsOn: CI
  condition: succeeded('CI')
  jobs:
  - job: publishpptx
    displayName: Publish course content
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: current
        downloadType: single
        artifactName: deck
        downloadPath: $(Build.SourcesDirectory)/out
    - task: GitHubRelease@0
      displayName: Create GitHub release
      inputs:
        gitHubConnection: seesharprun-github
        repositoryName: $(Build.Repository.Name)
        tagSource: manual
        tag: v$(Build.BuildNumber)
        title: Version $(Build.BuildNumber)
        releaseNotesSource: input
        releaseNotes: # Version $(Build.BuildNumber) Release
        assets: $(Build.SourcesDirectory)/out/**/*.*
        assetUploadMode: replace
        isPreRelease: true